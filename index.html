<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Montclair Referendum Impact</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #fdfdfd; padding: 20px; color: #333; line-height: 1.6; }
        /* Adjusted max-width to 850px to force a perfect 2x2 grid for the 4 charts */
        .container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; max-width: 850px; margin: 0 auto; }
        .chart-box { border: 1px solid #eee; padding: 15px; width: 380px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); background: #fff; }
        .controls { text-align: center; margin-bottom: 25px; }
        .toggle-btn { padding: 12px 30px; cursor: pointer; border: 2px solid #333; background: #fff; color: #333; font-weight: bold; font-size: 16px; border-radius: 8px; transition: 0.2s; margin: 0 5px; }
        .active { background: #333; color: white; }
        h1 { text-align: center; margin-bottom: 5px; font-size: 28px; }
        p.subtitle { text-align: center; color: #666; margin-bottom: 25px; font-size: 16px; }
        .unit-note { font-size: 11px; color: #888; text-align: right; margin-bottom: 10px; font-style: italic; }
        .chart-title { text-align: center; font-weight: bold; font-size: 15px; margin-bottom: 5px; color: #2c3e50; }
        
        .key-terms { max-width: 810px; margin: 40px auto; padding: 25px; background: #fff; border-left: 5px solid #2c3e50; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .term-item { margin-bottom: 12px; font-size: 14px; }
        .term-title { font-weight: bold; color: #2c3e50; }
        .tag-no { color: #d68910; font-weight: bold; }
        .tag-yes { color: #2980b9; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Montclair School Budget Impact</h1>
    <p class="subtitle">Visualizing the 2025-26 Referendum Question 2 and Future Projections</p>

    <div class="controls">
        <button id="no-btn" class="toggle-btn active" onclick="update(false)">Vote NO on Q2</button>
        <button id="yes-btn" class="toggle-btn" onclick="update(true)">Vote YES on Q2</button>
    </div>

    <div class="container">
        <div class="chart-box">
            <div class="chart-title">Current State (2025-26 Before Q2)</div>
            <div class="unit-note">All figures in Millions (M)</div>
            <div id="as-is"></div>
        </div>

        <div class="chart-box">
            <div id="title-25" class="chart-title">2025-26 Scenario: No on Q2</div>
            <div class="unit-note">All figures in Millions (M)</div>
            <div id="chart-25"></div>
        </div>

        <div class="chart-box">
            <div class="chart-title">Current State (2026-27 As is)</div>
            <div class="unit-note">All figures in Millions (M)</div>
            <div id="chart-26-asis"></div>
        </div>

        <div class="chart-box">
            <div id="title-26" class="chart-title">2026-27 Scenario: No on Q2</div>
            <div class="unit-note">All figures in Millions (M)</div>
            <div id="chart-26"></div>
        </div>
    </div>

    <div class="key-terms">
        <h3 style="margin-top:0;">Key Terms & Context</h3>
        <div class="term-item"><span class="term-title">Funding Gap:</span> The difference between projected expenditures and expected revenue.</div>
        <div class="term-item"><span class="tag-no">Advance of State Aid (Vote No):</span> A loan from the State covering the immediate gap, but must be repaid with interest.</div>
        <div class="term-item"><span class="tag-yes">Tax Levy (Vote Yes):</span> A permanent increase in local tax revenue to cover the gap directly, avoiding loans.</div>
        <div class="term-item"><span class="term-title">Mid-year Cuts:</span> Reductions required to balance the budget if existing revenue doesn't meet costs.</div>
        <div class="term-item"><span class="term-title">2026-27 Projections:</span> Shows the compounded effect in the following year, including potential losses in state aid and annualized mid-year cuts.</div>
    </div>

    <script>
        const w = 380, h = 420, margin = {top: 50, right: 40, bottom: 40, left: 50};
        
        // Padding at 0.55 makes bars narrower and the gap between them wider
        const x = d3.scaleBand().domain(["Revenue", "Expenditure"]).range([margin.left, w - margin.right]).padding(0.55);
        const y = d3.scaleLinear().domain([140, 175]).range([h - margin.bottom, margin.top]);

        let svgLeft, svg25, svg26AsIs, svg26;

        function addText(group, cx, cy, line1, line2, color, size) {
            const txt = group.append("text").attr("x", cx).attr("y", cy).attr("text-anchor", "middle").attr("fill", color).style("font-size", size).style("font-weight", "bold");
            txt.append("tspan").attr("x", cx).text(line1);
            if(line2) txt.append("tspan").attr("x", cx).attr("dy", "1.2em").text(line2);
        }

        // Dedicated function to draw the gap arrow in the empty space
        function drawArrow(group, xRightEdge, y1, y2, label1, label2) {
            const arrowX = xRightEdge + 15; 
            
            group.append("line").attr("x1", arrowX).attr("y1", y1).attr("x2", arrowX).attr("y2", y2)
                 .attr("stroke", "#ed7d31").attr("stroke-width", 2).attr("marker-start", "url(#arrow)").attr("marker-end", "url(#arrow)");
            
            // Text is anchored to the "start" (left) so it pushes out into the empty gap space
            const txt = group.append("text").attr("x", arrowX + 8).attr("y", (y1 + y2)/2 - 5)
                             .attr("fill", "#ed7d31").style("font-weight", "bold").style("font-size", "11px").attr("text-anchor", "start");
            txt.append("tspan").attr("x", arrowX + 8).text(label1);
            if(label2) txt.append("tspan").attr("x", arrowX + 8).attr("dy", "1.3em").text(label2);
        }

        function init() {
            svgLeft = d3.select("#as-is").append("svg").attr("width", w).attr("height", h);
            svg25 = d3.select("#chart-25").append("svg").attr("width", w).attr("height", h);
            svg26AsIs = d3.select("#chart-26-asis").append("svg").attr("width", w).attr("height", h);
            svg26 = d3.select("#chart-26").append("svg").attr("width", w).attr("height", h);

            [svgLeft, svg25, svg26AsIs, svg26].forEach(svg => {
                svg.append("g").attr("transform", `translate(${margin.left},0)`).call(d3.axisLeft(y).ticks(8).tickFormat(d => "$" + d + "M"));
                svg.append("g").attr("transform", `translate(0,${h - margin.bottom})`).call(d3.axisBottom(x));
                
                svg.append("defs").append("marker")
                    .attr("id", "arrow").attr("viewBox", "0 0 10 10").attr("refX", 5).attr("refY", 5)
                    .attr("markerWidth", 5).attr("markerHeight", 5).attr("orient", "auto")
                    .append("path").attr("d", "M 0 0 L 10 5 L 0 10 z").attr("fill", "#ed7d31");
            });

            renderStatic();
            update(false); 
        }

        function renderStatic() {
            // --- 1. Current State (2025-26 Before Q2) ---
            svgLeft.append("rect").attr("x", x("Revenue")).attr("y", y(154.2)).attr("width", x.bandwidth()).attr("height", y(140) - y(154.2)).attr("fill", "#4a71be");
            addText(svgLeft, x("Revenue") + x.bandwidth()/2, y(154.2) + 20, "$154.2M", null, "white", "11px");

// Solid green Expenditure bar up to 159.2
            svgLeft.append("rect").attr("x", x("Expenditure")).attr("y", y(159.2)).attr("width", x.bandwidth()).attr("height", y(140) - y(159.2)).attr("fill", "#54ad66");
            addText(svgLeft, x("Expenditure") + x.bandwidth()/2, y(159.2) + 20, "$159.2M", null, "white", "11px");

            // Dashed Cut box sitting ON TOP (from 159.2 up to 162.0)
            svgLeft.append("rect").attr("x", x("Expenditure")).attr("y", y(162.0)).attr("width", x.bandwidth()).attr("height", y(159.2) - y(162.0)).attr("fill", "#e2efda").attr("stroke", "#333").attr("stroke-dasharray", "4");
            addText(svgLeft, x("Expenditure") + x.bandwidth()/2, y(162.0) + 14, "Mid-year Cut", "$2.8M", "#333", "10px");

            // Fixed Arrow: Stops cleanly at 159.2 base
            drawArrow(svgLeft, x("Revenue") + x.bandwidth(), y(154.2), y(159.2), "$5M", "Cuts Needed");

            // --- 2. Current State (2026-27 As is) ---
            svg26AsIs.append("rect").attr("x", x("Revenue")).attr("y", y(155.2)).attr("width", x.bandwidth()).attr("height", y(140) - y(155.2)).attr("fill", "#4a71be");
            addText(svg26AsIs, x("Revenue") + x.bandwidth()/2, y(155.2) + 20, "$155.2M", null, "white", "11px");

            svg26AsIs.append("rect").attr("x", x("Expenditure")).attr("y", y(163.9)).attr("width", x.bandwidth()).attr("height", y(140) - y(163.9)).attr("fill", "#54ad66");
            addText(svg26AsIs, x("Expenditure") + x.bandwidth()/2, y(163.9) + 20, "$163.9M", null, "white", "11px");

            svg26AsIs.append("rect").attr("x", x("Expenditure")).attr("y", y(167.4)).attr("width", x.bandwidth()).attr("height", y(163.9) - y(167.4)).attr("fill", "#e2efda").attr("stroke", "#333").attr("stroke-dasharray", "4");
            addText(svg26AsIs, x("Expenditure") + x.bandwidth()/2, y(167.4) + 14, "Mid Year Cuts", "Annualized $3.5M", "#333", "9px");

            // Arrow: Stops cleanly at 163.9 base
            drawArrow(svg26AsIs, x("Revenue") + x.bandwidth(), y(155.2), y(163.9), "$8.7M", "Cuts Needed");
        }

        function update(isYes) {
            d3.select("#no-btn").classed("active", !isYes);
            d3.select("#yes-btn").classed("active", isYes);
            d3.select("#title-25").text(`2025-26 Scenario: ${isYes ? 'Yes' : 'No'} on Q2`);
            d3.select("#title-26").text(`2026-27 Scenario: ${isYes ? 'Yes' : 'No'} on Q2`);
            
            svg25.selectAll(".dynamic-content").remove();
            svg26.selectAll(".dynamic-content").remove();
            
            const g25 = svg25.append("g").attr("class", "dynamic-content");
            const g26 = svg26.append("g").attr("class", "dynamic-content");

            // --- CHART 3: 2025-26 SCENARIO ---
            g25.append("rect").attr("x", x("Revenue")).attr("y", y(154.2)).attr("width", x.bandwidth()).attr("height", y(140) - y(154.2)).attr("fill", "#4a71be");
            addText(g25, x("Revenue") + x.bandwidth()/2, y(154.2) + 20, "$154.2M", null, "white", "11px");
            
            g25.append("rect").attr("x", x("Revenue")).attr("y", y(159.2)).attr("width", x.bandwidth()).attr("height", y(154.2) - y(159.2)).attr("fill", isYes ? "#5bace3" : "#ffc000");
            addText(g25, x("Revenue") + x.bandwidth()/2, y(159.2) + 16, isYes ? "Tax Levy" : "Advance Aid", "$5.0M", "#333", "10px");

            // Solid green Expenditure bar up to 159.2
            g25.append("rect").attr("x", x("Expenditure")).attr("y", y(159.2)).attr("width", x.bandwidth()).attr("height", y(140) - y(159.2)).attr("fill", "#54ad66");
            addText(g25, x("Expenditure") + x.bandwidth()/2, y(159.2) + 20, "$159.2M", null, "white", "11px");

            // Dashed Cut box sitting ON TOP (from 159.2 up to 162.0)
            g25.append("rect").attr("x", x("Expenditure")).attr("y", y(162.0)).attr("width", x.bandwidth()).attr("height", y(159.2) - y(162.0)).attr("fill", "#e2efda").attr("stroke", "#333").attr("stroke-dasharray", "4");
            addText(g25, x("Expenditure") + x.bandwidth()/2, y(162.0) + 14, "Mid-year Cut", "$2.8M", "#333", "10px");            // --- CHART 4: 2026-27 SCENARIO ---
           
            if (!isYes) {
                g26.append("rect").attr("x", x("Revenue")).attr("y", y(153.3)).attr("width", x.bandwidth()).attr("height", y(140) - y(153.3)).attr("fill", "#4a71be");
                addText(g26, x("Revenue") + x.bandwidth()/2, y(153.3) + 20, "$153.3M", null, "white", "11px");

                g26.append("rect").attr("x", x("Revenue")).attr("y", y(155.15)).attr("width", x.bandwidth()).attr("height", y(153.3) - y(155.15)).attr("fill", "#e8eaf6").attr("stroke", "#333").attr("stroke-dasharray", "4");
                
                // FLOATING TEXT for Less State Aid to avoid overlap
                addText(g26, x("Revenue") + x.bandwidth()/2, y(155.15) - 22, "Less State Aid", "$1.85M", "#333", "10px");

                g26.append("rect").attr("x", x("Expenditure")).attr("y", y(163.9)).attr("width", x.bandwidth()).attr("height", y(140) - y(163.9)).attr("fill", "#54ad66");
                addText(g26, x("Expenditure") + x.bandwidth()/2, y(163.9) + 20, "$163.9M", null, "white", "11px");

                g26.append("rect").attr("x", x("Expenditure")).attr("y", y(167.4)).attr("width", x.bandwidth()).attr("height", y(163.9) - y(167.4)).attr("fill", "#e2efda").attr("stroke", "#333").attr("stroke-dasharray", "4");
                addText(g26, x("Expenditure") + x.bandwidth()/2, y(167.4) + 14, "Mid Year Cut", "Annualized $3.5M", "#333", "9px");

                drawArrow(g26, x("Revenue") + x.bandwidth(), y(153.3), y(163.9), "$10M", "Cuts Needed");

            } else {
                g26.append("rect").attr("x", x("Revenue")).attr("y", y(160.2)).attr("width", x.bandwidth()).attr("height", y(140) - y(160.2)).attr("fill", "#4a71be");
                addText(g26, x("Revenue") + x.bandwidth()/2, y(160.2) + 20, "$160.2M", null, "white", "11px");

                g26.append("rect").attr("x", x("Expenditure")).attr("y", y(163.9)).attr("width", x.bandwidth()).attr("height", y(140) - y(163.9)).attr("fill", "#54ad66");
                addText(g26, x("Expenditure") + x.bandwidth()/2, y(163.9) + 20, "$163.9M", null, "white", "11px");

                g26.append("rect").attr("x", x("Expenditure")).attr("y", y(167.4)).attr("width", x.bandwidth()).attr("height", y(163.9) - y(167.4)).attr("fill", "#e2efda").attr("stroke", "#333").attr("stroke-dasharray", "4");
                addText(g26, x("Expenditure") + x.bandwidth()/2, y(167.4) + 14, "Mid Year Cut", "Annualized $3.5M", "#333", "9px");

                drawArrow(g26, x("Revenue") + x.bandwidth(), y(160.2), y(163.9), "$3.7M", "Cuts Needed");
            }
        }

        window.onload = init;
    </script>
</body>
</html>
