<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Montclair Referendum Impact</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #fdfdfd; padding: 20px; color: #333; line-height: 1.6; }
        
        .container { display: flex; flex-wrap: wrap; justify-content: space-between; max-width: 1050px; margin: 0 auto; }
        .chart-box { width: 49%; min-width: 320px; box-sizing: border-box; border: 1px solid #eee; padding: 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); background: #fff; margin-bottom: 20px; }
        
        /* New Text Block Styling */
        .text-section { max-width: 1050px; margin: 0 auto 25px auto; padding: 20px 25px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); box-sizing: border-box; }
        .text-section p { margin-top: 0; margin-bottom: 12px; font-size: 15px; }
        .text-section p:last-child { margin-bottom: 0; }
        .notes-text { font-style: italic; color: #555; font-size: 14px; }
        
        .controls { text-align: center; margin-bottom: 25px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); max-width: 700px; margin-left: auto; margin-right: auto; }
        
        .master-btn { padding: 12px 30px; cursor: pointer; border: 2px solid #2c3e50; background: #f8f9fa; color: #2c3e50; font-weight: bold; font-size: 16px; border-radius: 8px; transition: 0.2s; display: inline-block; margin-bottom: 15px; }
        .master-btn.active { background: #2c3e50; color: white; }
        
        .control-group { margin: 10px 0; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 10px; }
        .control-label { font-weight: bold; margin-right: 10px; font-size: 16px; color: #2c3e50; min-width: 110px; text-align: right; }
        .toggle-btn { padding: 10px 20px; cursor: pointer; border: 2px solid #333; background: #fff; color: #333; font-weight: bold; font-size: 14px; border-radius: 6px; transition: 0.2s; }
        .toggle-btn.active { background: #333; color: white; }
        
        h1 { text-align: center; margin-bottom: 5px; font-size: 28px; }
        p.subtitle { text-align: center; color: #666; margin-bottom: 25px; font-size: 16px; font-weight: bold; }
        .unit-note { font-size: 11px; color: #888; text-align: right; margin-bottom: 10px; font-style: italic; }
        .chart-title { text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 5px; color: #2c3e50; }
        
        .key-terms { max-width: 1050px; margin: 20px auto 40px auto; padding: 25px; background: #fff; border-left: 5px solid #2c3e50; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); box-sizing: border-box; }
        .term-item { margin-bottom: 12px; font-size: 14px; }
        .term-title { font-weight: bold; color: #2c3e50; }
        .tag-no { color: #d68910; font-weight: bold; }
        .tag-yes { color: #2980b9; font-weight: bold; }

        .tables-container { display: flex; flex-wrap: wrap; justify-content: space-between; max-width: 1050px; margin: 30px auto; }
        .tax-table-wrapper { width: 49%; min-width: 320px; box-sizing: border-box; margin-bottom: 20px; }
        .tax-table { border-collapse: collapse; width: 100%; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-radius: 8px; overflow: hidden; }
        .tax-table th { background: #2c3e50; color: white; padding: 12px; font-size: 14px; text-align: left; }
        .tax-table td { padding: 10px 12px; border-bottom: 1px solid #eee; font-size: 14px; color: #333; }
        .tax-table tr:last-child td { border-bottom: none; }
        .table-title { font-weight: bold; font-size: 16px; margin-bottom: 10px; color: #2c3e50; text-align: center; }

        @media (max-width: 768px) {
            .chart-box, .tax-table-wrapper { width: 100%; }
            .control-label { text-align: center; width: 100%; margin-bottom: 5px; }
        }
    </style>
</head>
<body>

    <h1>Montclair School Budget Impact</h1>
    <p class="subtitle">Visualizing the Impact of the Referendum Questions on Future Projections</p>

    <div class="text-section">
        <p>There are a number of relevant pieces to the district’s projections and the vote outcomes. The district has provided information in the form of tables, but we hope this visual can provide clarity on how the vote interacts with revenue, expenditures, the appointment of a monitor, aid advances/“payback” of aid, and projected additional cuts needed in the budget cycle. Our aim was to provide enough detail to show the big picture but not make the charts too busy with further breakdowns of revenue and expenditures. Please note that these graphs are at a $140m baseline (non-zero baselines distort data), but it allows us to zoom in on the differences between scenarios.</p>
        <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
        <p><strong>Question 1:</strong> One-time increase to the district’s tax levy to cover the $12.6 million debt accumulated over prior years. If this measure doesn’t pass then the district will take an advance of state aid to cover this amount.</p>
        <p><strong>Question 2:</strong> Permanent increase to the district’s tax levy to raise an additional $5 million over the amount raised for the 2025-2026 school year. If this measure doesn’t pass then the district will take an advance of state aid to cover this amount for the 2025-2026 school year.</p>
        <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
        <p class="notes-text">Note: All numbers are projections and the state budget is not finalized yet.<br>
        Note: Q1 Yes does not have an impact on 25-26 Scenario because the debt is from prior years.</p>
    </div>

    <div class="controls">
        <button id="btn-asis" class="master-btn active" onclick="setAsIs()">View "As-Is" Baseline</button>
        
        <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0 20px 0;">

        <div class="control-group">
            <span class="control-label">Question 1:</span>
            <button id="q1-yes" class="toggle-btn q1-btn" onclick="handleVote('q1', 'yes')">Vote YES</button>
            <button id="q1-no" class="toggle-btn q1-btn" onclick="handleVote('q1', 'no')">Vote NO</button>
        </div>
        <div class="control-group">
            <span class="control-label">Question 2:</span>
            <button id="q2-yes" class="toggle-btn q2-btn" onclick="handleVote('q2', 'yes')">Vote YES</button>
            <button id="q2-no" class="toggle-btn q2-btn" onclick="handleVote('q2', 'no')">Vote NO</button>
        </div>
    </div>

    <div class="container">
        <div class="chart-box">
            <div id="title-25" class="chart-title">2025-26 Scenario: As-Is Baseline</div>
            <div class="unit-note">All figures in Millions (M)</div>
            <div id="chart-25"></div>
        </div>

        <div class="chart-box">
            <div id="title-26" class="chart-title">26/27 Scenario: As-Is Baseline</div>
            <div class="unit-note">All figures in Millions (M)</div>
            <div id="chart-26"></div>
        </div>
    </div>

    <div class="key-terms">
        <h3 style="margin-top:0;">Key Terms & Context</h3>
        <div class="term-item"><span class="term-title">Gap:</span> The difference between projected expenditures and projected revenue.</div>
        <div class="term-item"><span class="tag-no">Advance of State Aid (Vote No):</span> An advance of future state aid, future year state aid amounts are lower to account for the aid already advanced (less state aid).</div>
        <div class="term-item"><span class="tag-yes">Tax Levy (Vote Yes):</span> A permanent increase in local tax revenue.</div>
        <div class="term-item"><span class="term-title">Mid-year Cuts:</span> Cuts implemented in January 2026. $2.8M in 25-26, and $3.5m when in place over the full 26-27 school year.</div>
        <div class="term-item"><span class="term-title">Monitor:</span> In the event of a no vote for either question, the district will take an advance of state aid. If the district takes any advance, then the state will assign a state monitor.</div>
        <div class="term-item"><span class="term-title">Interest on Tax Anticipation Notes:</span> The district must pay its debts before the tax revenue will be collected. These notes allow the district to borrow money as a bridge. The district must pay interest on this short term bridge.</div>
        <div class="term-item"><span class="term-title">Cuts needed:</span> The amount of cuts the district will have to make to balance expenditures and revenues in 26/27 under each voting outcome scenario.</div>
    </div>

    <div class="tables-container">
        <div class="tax-table-wrapper">
            <div class="table-title">Q1 Tax Impact (One-Time)</div>
            <table class="tax-table">
                <tr><th>Assessed Home Value</th><th>Tax</th></tr>
                <tr><td>$400,000</td><td>$698.80</td></tr>
                <tr><td>$639,630</td><td>$1,117.43</td></tr>
                <tr><td>$1,000,000</td><td>$1,746.99</td></tr>
            </table>
        </div>
        <div class="tax-table-wrapper">
            <div class="table-title">Q2 Tax Impact (Built into the Base)</div>
            <table class="tax-table">
                <tr><th>Assessed Home Value</th><th>Tax</th></tr>
                <tr><td>$400,000</td><td>$277.20</td></tr>
                <tr><td>$639,630</td><td>$443.26</td></tr>
                <tr><td>$1,000,000</td><td>$693.00</td></tr>
            </table>
        </div>
    </div>

    <script>
        const w = 460, h = 420, margin = {top: 50, right: 80, bottom: 40, left: 50};        
        const x = d3.scaleBand().domain(["Revenue", "Expenditure"]).range([margin.left, w - margin.right]).padding(0.55);
        const y = d3.scaleLinear().domain([140, 175]).range([h - margin.bottom, margin.top]);

        let svg25, svg26;
        
        // Track the current application state
        let isAsIs = true;
        let hasVoted = false; // Tracks if it's the user's first time clicking a vote toggle
        let currentQ1 = 'no'; 
        let currentQ2 = 'no'; 

        // Separating the "Base Revenue" from the "Q2 Tax Levy" so they stack dynamically
        const scenarios26 = {
            'no-no':   { baseRev: 153.5, taxLevy: 0,   topRev: 155.3, stateAidLoss: 1.8, stateAidText: "$1.8M", expBase: 163.8, monitor: 0.15, interest: 0,     intText: "",      gapText: "$10.4M" },
            'yes-no':  { baseRev: 154.8, taxLevy: 0,   topRev: 155.3, stateAidLoss: 0.5, stateAidText: "$500k", expBase: 163.8, monitor: 0.15, interest: 0.252, intText: "$252k", gapText: "$9.4M" },
            'no-yes':  { baseRev: 154.0, taxLevy: 5.1, topRev: 160.4, stateAidLoss: 1.3, stateAidText: "$1.3M", expBase: 163.8, monitor: 0.15, interest: 0.1,   intText: "$100k", gapText: "$4.9M" },
            'yes-yes': { baseRev: 155.3, taxLevy: 5.1, topRev: 160.4, stateAidLoss: 0,   stateAidText: "",      expBase: 163.8, monitor: 0,    interest: 0.35,  intText: "$350k", gapText: "$3.7M" }
        };

        function addText(group, cx, cy, line1, line2, color, size) {
            const txt = group.append("text").attr("x", cx).attr("y", cy).attr("text-anchor", "middle").attr("fill", color).style("font-size", size).style("font-weight", "bold");
            txt.append("tspan").attr("x", cx).text(line1);
            if(line2) txt.append("tspan").attr("x", cx).attr("dy", "1.2em").text(line2);
        }

        function drawArrow(group, xRightEdge, y1, y2, label1, label2, label3) {
            const arrowX = xRightEdge + 12; 
            group.append("line").attr("x1", arrowX).attr("y1", y1).attr("x2", arrowX).attr("y2", y2)
                 .attr("stroke", "#ed7d31").attr("stroke-width", 2).attr("marker-start", "url(#arrow)").attr("marker-end", "url(#arrow)");
            
            const txt = group.append("text").attr("x", arrowX + 6).attr("y", (y1 + y2)/2 - 10)
                             .attr("fill", "#ed7d31").style("font-weight", "bold").style("font-size", "11px").attr("text-anchor", "start");
            txt.append("tspan").attr("x", arrowX + 6).text(label1);
            if(label2) txt.append("tspan").attr("x", arrowX + 6).attr("dy", "1.3em").text(label2);
            if(label3) txt.append("tspan").attr("x", arrowX + 6).attr("dy", "1.3em").text(label3);
        }

        function init() {
            svg25 = d3.select("#chart-25").append("svg").attr("viewBox", `0 0 ${w} ${h}`).style("max-width", "100%").style("height", "auto");
            svg26 = d3.select("#chart-2
