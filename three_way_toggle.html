<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Montclair Referendum Impact</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #fdfdfd; padding: 20px; color: #333; line-height: 1.6; }
        
        .container { display: flex; flex-wrap: wrap; justify-content: space-between; max-width: 1050px; margin: 0 auto; }
        .chart-box { width: 49%; min-width: 320px; box-sizing: border-box; border: 1px solid #eee; padding: 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); background: #fff; margin-bottom: 20px; }
        
        .controls { text-align: center; margin-bottom: 25px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); max-width: 700px; margin-left: auto; margin-right: auto; }
        
        /* Master As-Is Button Styling */
        .master-btn { padding: 12px 30px; cursor: pointer; border: 2px solid #2c3e50; background: #f8f9fa; color: #2c3e50; font-weight: bold; font-size: 16px; border-radius: 8px; transition: 0.2s; display: inline-block; margin-bottom: 15px; }
        .master-btn.active { background: #2c3e50; color: white; }
        
        .control-group { margin: 10px 0; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 10px; }
        .control-label { font-weight: bold; margin-right: 10px; font-size: 16px; color: #2c3e50; min-width: 110px; text-align: right; }
        .toggle-btn { padding: 10px 20px; cursor: pointer; border: 2px solid #333; background: #fff; color: #333; font-weight: bold; font-size: 14px; border-radius: 6px; transition: 0.2s; }
        .toggle-btn.active { background: #333; color: white; }
        
        h1 { text-align: center; margin-bottom: 5px; font-size: 28px; }
        p.subtitle { text-align: center; color: #666; margin-bottom: 25px; font-size: 16px; }
        .unit-note { font-size: 11px; color: #888; text-align: right; margin-bottom: 10px; font-style: italic; }
        .chart-title { text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 5px; color: #2c3e50; }
        
        .key-terms { max-width: 1050px; margin: 20px auto 40px auto; padding: 25px; background: #fff; border-left: 5px solid #2c3e50; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); box-sizing: border-box; }
        .term-item { margin-bottom: 12px; font-size: 14px; }
        .term-title { font-weight: bold; color: #2c3e50; }
        .tag-no { color: #d68910; font-weight: bold; }
        .tag-yes { color: #2980b9; font-weight: bold; }

        .tables-container { display: flex; flex-wrap: wrap; justify-content: space-between; max-width: 1050px; margin: 30px auto; }
        .tax-table-wrapper { width: 49%; min-width: 320px; box-sizing: border-box; margin-bottom: 20px; }
        .tax-table { border-collapse: collapse; width: 100%; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-radius: 8px; overflow: hidden; }
        .tax-table th { background: #2c3e50; color: white; padding: 12px; font-size: 14px; text-align: left; }
        .tax-table td { padding: 10px 12px; border-bottom: 1px solid #eee; font-size: 14px; color: #333; }
        .tax-table tr:last-child td { border-bottom: none; }
        .table-title { font-weight: bold; font-size: 16px; margin-bottom: 10px; color: #2c3e50; text-align: center; }

        @media (max-width: 768px) {
            .chart-box, .tax-table-wrapper { width: 100%; }
            .control-label { text-align: center; width: 100%; margin-bottom: 5px; }
        }
    </style>
</head>
<body>

    <h1>Montclair School Budget Impact</h1>
    <p class="subtitle">Visualizing the impact of the Referendum Questions on Future Projections</p>

    <div class="controls">
        <button id="btn-asis" class="master-btn active" onclick="setAsIs()">View "As-Is" Baseline</button>
        
        <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0 20px 0;">

        <div class="control-group">
            <span class="control-label">Question 1:</span>
            <button id="q1-no" class="toggle-btn q1-btn" onclick="setVote('no', currentQ2)">Vote NO</button>
            <button id="q1-yes" class="toggle-btn q1-btn" onclick="setVote('yes', currentQ2)">Vote YES</button>
        </div>
        <div class="control-group">
            <span class="control-label">Question 2:</span>
            <button id="q2-no" class="toggle-btn q2-btn" onclick="setVote(currentQ1, 'no')">Vote NO</button>
            <button id="q2-yes" class="toggle-btn q2-btn" onclick="setVote(currentQ1, 'yes')">Vote YES</button>
        </div>
    </div>

    <div class="container">
        <div class="chart-box">
            <div id="title-25" class="chart-title">2025-26 Scenario</div>
            <div class="unit-note">All figures in Millions (M)</div>
            <div id="chart-25"></div>
        </div>

        <div class="chart-box">
            <div id="title-26" class="chart-title">2026-27 Scenario</div>
            <div class="unit-note">All figures in Millions (M)</div>
            <div id="chart-26"></div>
        </div>
    </div>

    <div class="key-terms">
        <h3 style="margin-top:0;">Key Terms & Context</h3>
        <div class="term-item"><span class="term-title">Gap:</span> The difference between projected expenditures and revenue.</div>
        <div class="term-item"><span class="tag-no">Advance of State Aid (Vote No):</span> An advance of future state aid, future year state aid amounts are lower to account for the aid already advanced.</div>
        <div class="term-item"><span class="tag-yes">Tax Levy (Vote Yes):</span> A permanent increase in local tax revenue.</div>
        <div class="term-item"><span class="term-title">Mid-year Cuts:</span> Cuts implemented in January 2026. $2.8M in 25-26, and $3.5m over the full year in 26-27.</div>
        <div class="term-item"><span class="term-title">Cuts needed:</span> The amount of cuts the district will have to make to balance expenditures and revenues in 26/27 under each voting outcome scenario.</div>
    </div>

    <div class="tables-container">
        <div class="tax-table-wrapper">
            <div class="table-title">Q1 Tax Impact (One-Time)</div>
            <table class="tax-table">
                <tr><th>Assessed Home Value</th><th>Tax</th></tr>
                <tr><td>$400,000</td><td>$698.80</td></tr>
                <tr><td>$639,630</td><td>$1,117.43</td></tr>
                <tr><td>$1,000,000</td><td>$1,746.99</td></tr>
            </table>
        </div>
        <div class="tax-table-wrapper">
            <div class="table-title">Q2 Tax Impact (Built into the Base)</div>
            <table class="tax-table">
                <tr><th>Assessed Home Value</th><th>Tax</th></tr>
                <tr><td>$400,000</td><td>$277.20</td></tr>
                <tr><td>$639,630</td><td>$443.26</td></tr>
                <tr><td>$1,000,000</td><td>$693.00</td></tr>
            </table>
        </div>
    </div>

    <script>
        const w = 460, h = 420, margin = {top: 50, right: 80, bottom: 40, left: 50};        
        const x = d3.scaleBand().domain(["Revenue", "Expenditure"]).range([margin.left, w - margin.right]).padding(0.55);
        const y = d3.scaleLinear().domain([140, 175]).range([h - margin.bottom, margin.top]);

        let svg25, svg26;
        
        // Track the current application state
        let isAsIs = true;
        let currentQ1 = 'no'; // Background default for when user clicks out of As-Is
        let currentQ2 = 'no'; // Background default for when user clicks out of As-Is

        // Only the 4 active voting scenarios remain
        const scenarios26 = {
            'no-no':   { revTop: 155.3, revSolid: 153.5, stateAidLoss: 1.8, stateAidText: "$1.8M", expBase: 163.8, monitor: 0.15, interest: 0, intText: "", gapText: "$10.4M" },
            'yes-no':  { revTop: 155.3, revSolid: 154.8, stateAidLoss: 0.5, stateAidText: "$500k", expBase: 163.8, monitor: 0.15, interest: 0.252, intText: "$252k", gapText: "$9.4M" },
            'no-yes':  { revTop: 160.4, revSolid: 159.1, stateAidLoss: 1.3, stateAidText: "$1.3M", expBase: 163.8, monitor: 0.15, interest: 0.1, intText: "$100k", gapText: "$4.9M" },
            'yes-yes': { revTop: 160.4, revSolid: 160.4, stateAidLoss: 0, stateAidText: "", expBase: 163.8, monitor: 0, interest: 0.35, intText: "$350k", gapText: "$3.7M" }
        };

        function addText(group, cx, cy, line1, line2, color, size) {
            const txt = group.append("text").attr("x", cx).attr("y", cy).attr("text-anchor", "middle").attr("fill", color).style("font-size", size).style("font-weight", "bold");
            txt.append("tspan").attr("x", cx).text(line1);
            if(line2) txt.append("tspan").attr("x", cx).attr("dy", "1.2em").text(line2);
        }

        function drawArrow(group, xRightEdge, y1, y2, label1, label2, label3) {
            const arrowX = xRightEdge + 12; 
            group.append("line").attr("x1", arrowX).attr("y1", y1).attr("x2", arrowX).attr("y2", y2)
                 .attr("stroke", "#ed7d31").attr("stroke-width", 2).attr("marker-start", "url(#arrow)").attr("marker-end", "url(#arrow)");
            
            const txt = group.append("text").attr("x", arrowX + 6).attr("y", (y1 + y2)/2 - 10)
                             .attr("fill", "#ed7d31").style("font-weight", "bold").style("font-size", "11px").attr("text-anchor", "start");
            txt.append("tspan").attr("x", arrowX + 6).text(label1);
            if(label2) txt.append("tspan").attr("x", arrowX + 6).attr("dy", "1.3em").text(label2);
            if(label3) txt.append("tspan").attr("x", arrowX + 6).attr("dy", "1.3em").text(label3);
        }

        function init() {
            svg25 = d3.select("#chart-25").append("svg").attr("viewBox", `0 0 ${w} ${h}`).style("max-width", "100%").style("height", "auto");
            svg26 = d3.select("#chart-26").append("svg").attr("viewBox", `0 0 ${w} ${h}`).style("max-width", "100%").style("height", "auto");

            [svg25, svg26].forEach(svg => {
                svg.append("g").attr("transform", `translate(${margin.left},0)`).call(d3.axisLeft(y).ticks(8).tickFormat(d => "$" + d + "M"));
                svg.append("g").attr("transform", `translate(0,${h - margin.bottom})`).call(d3.axisBottom(x));
                
                svg.append("defs").append("marker")
                    .attr("id", "arrow").attr("viewBox", "0 0 10 10").attr("refX", 5).attr("refY", 5)
                    .attr("markerWidth", 5).attr("markerHeight", 5).attr("orient", "auto")
                    .append("path").attr("d", "M 0 0 L 10 5 L 0 10 z").attr("fill", "#ed7d31");
            });

            setAsIs(); 
        }

        function setAsIs() {
            isAsIs = true;
            
            // UI Button Updates
            d3.select("#btn-asis").classed("active", true);
            d3.selectAll(".q1-btn, .q2-btn").classed("active", false);
            
            // Title Updates
            d3.select("#title-25").text(`2025-26 Scenario: As-Is Baseline`);
            d3.select("#title-26").text(`2026-27 Scenario: As-Is Baseline`);
            
            renderCharts();
        }

        function setVote(q1, q2) {
            isAsIs = false;
            currentQ1 = q1;
            currentQ2 = q2;

            // UI Button Updates
            d3.select("#btn-asis").classed("active", false);
            d3.selectAll(".q1-btn").classed("active", false);
            d3.select("#q1-" + q1).classed("active", true);
            d3.selectAll(".q2-btn").classed("active", false);
            d3.select("#q2-" + q2).classed("active", true);

            // Title Updates
            d3.select("#title-25").text(`2025-26 Scenario: Q2 ${q2.toUpperCase()}`);
            d3.select("#title-26").text(`2026-27 Scenario: Q1 ${q1.toUpperCase()}, Q2 ${q2.toUpperCase()}`);

            renderCharts();
        }

        function renderCharts() {
            svg25.selectAll(".dynamic-content").remove();
            svg26.selectAll(".dynamic-content").remove();
            
            const g25 = svg25.append("g").attr("class", "dynamic-content");
            const g26 = svg26.append("g").attr("class", "dynamic-content");

            // ==========================================
            // CHART 1: 2025-26 SCENARIO
            // ==========================================
            g25.append("rect").attr("x", x("Revenue")).attr("y", y(154.2)).attr("width", x.bandwidth()).attr("height", y(140) - y(154.2)).attr("fill", "#4a71be");
            addText(g25, x("Revenue") + x.bandwidth()/2, y(154.2) + 20, "$154.2M", null, "white", "11px");
            
            if (!isAsIs) {
                if (currentQ2 === 'no') {
                    g25.append("rect").attr("x", x("Revenue")).attr("y", y(159.2)).attr("width", x.bandwidth()).attr("height", y(154.2) - y(159.2)).attr("fill", "#ffc000");
                    addText(g25, x("Revenue") + x.bandwidth()/2, y(159.2) + 16, "Advance Aid", "$5.0M", "#333", "10px");
                } else if (currentQ2 === 'yes') {
                    g25.append("rect").attr("x", x("Revenue")).attr("y", y(159.2)).attr("width", x.bandwidth()).attr("height", y(154.2) - y(159.2)).attr("fill", "#5bace3");
                    addText(g25, x("Revenue") + x.bandwidth()/2, y(159.2) + 16, "Tax Levy", "$5.0M", "#333", "10px");
                }
            }

            g25.append("rect").attr("x", x("Expenditure")).attr("y", y(159.2)).attr("width", x.bandwidth()).attr("height", y(140) - y(159.2)).attr("fill", "#db7d2a");
            addText(g25, x("Expenditure") + x.bandwidth()/2, y(159.2) + 20, "$159.2M", null, "white", "11px");

            g25.append("rect").attr("x", x("Expenditure")).attr("y", y(162.0)).attr("width", x.bandwidth()).attr("height", y(159.2) - y(162.0)).attr("fill", "#e2efda").attr("stroke", "#333").attr("stroke-dasharray", "4");
            addText(g25, x("Expenditure") + x.bandwidth()/2, y(162.0) + 14, "Mid-year Cut", "$2.8M", "#333", "10px");

            // Only draw Gap arrow in the As-Is state
            if (isAsIs) {
                drawArrow(g25, x("Revenue") + x.bandwidth(), y(154.2), y(159.2), "$5.0M", "Gap", null);
            }

            // ==========================================
            // CHART 2: 2026-27 SCENARIO
            // ==========================================
            if (isAsIs) {
                // Draw the pure baseline state
                g26.append("rect").attr("x", x("Revenue")).attr("y", y(155.3)).attr("width", x.bandwidth()).attr("height", y(140) - y(155.3)).attr("fill", "#4a71be");
                addText(g26, x("Revenue") + x.bandwidth()/2, y(155.3) + 20, "$155.3M", null, "white", "11px");

                g26.append("rect").attr("x", x("Expenditure")).attr("y", y(163.8)).attr("width", x.bandwidth()).attr("height", y(140) - y(163.8)).attr("fill", "#db7d2a");
                addText(g26, x("Expenditure") + x.bandwidth()/2, y(163.8) + 20, "$163.8M", null, "white", "11px");

                g26.append("rect").attr("x", x("Expenditure")).attr("y", y(167.3)).attr("width", x.bandwidth()).attr("height", y(163.8) - y(167.3)).attr("fill", "#e2efda").attr("stroke", "#333").attr("stroke-dasharray", "4");
                addText(g26, x("Expenditure") + x.bandwidth()/2, y(167.3) + 14, "Mid Year Cuts", "Annualized $3.5M", "#333", "9px");

                drawArrow(g26, x("Revenue") + x.bandwidth(), y(155.3), y(163.8), "$8.8M", "Cuts", "Needed");
            
            } else {
                // Draw the selected voting scenario from the 4-item matrix
                const s26 = scenarios26[`${currentQ1}-${currentQ2}`];
                
                // Base Revenue Block
                const baseRevEnd = Math.min(155.3, s26.revSolid);
                g26.append("rect").attr("x", x("Revenue")).attr("y", y(baseRevEnd)).attr("width", x.bandwidth()).attr("height", y(140) - y(baseRevEnd)).attr("fill", "#4a71be");
                addText(g26, x("Revenue") + x.bandwidth()/2, y(baseRevEnd) + 20, "$" + baseRevEnd.toFixed(1) + "M", null, "white", "11px");

                // Tax Levy Block
                if (s26.revSolid > 155.3) {
                    g26.append("rect").attr("x", x("Revenue")).attr("y", y(s26.revSolid)).attr("width", x.bandwidth()).attr("height", y(155.3) - y(s26.revSolid)).attr("fill", "#5bace3");
                    const taxLevyAmount = (s26.revSolid - 155.3).toFixed(1);
                    addText(g26, x("Revenue") + x.bandwidth()/2, y(s26.revSolid) + 16, "Tax Levy", "$" + taxLevyAmount + "M", "#333", "10px");
                }

                // State Aid Loss
                if (s26.stateAidLoss > 0) {
                    g26.append("rect").attr("x", x("Revenue")).attr("y", y(s26.revTop)).attr("width", x.bandwidth()).attr("height", y(s26.revSolid) - y(s26.revTop)).attr("fill", "#e8eaf6").attr("stroke", "#333").attr("stroke-dasharray", "4");
                    addText(g26, x("Revenue") + x.bandwidth()/2, y(s26.revTop) - 22, "Less State Aid", s26.stateAidText, "#333", "10px");
                }

                // Expenditure Base
                g26.append("rect").attr("x", x("Expenditure")).attr("y", y(s26.expBase)).attr("width", x.bandwidth()).attr("height", y(140) - y(s26.expBase)).attr("fill", "#db7d2a");
                addText(g26, x("Expenditure") + x.bandwidth()/2, y(s26.expBase) + 20, "$" + s26.expBase + "M", null, "white", "11px");

                const monitorTop = s26.expBase + s26.monitor;
                const interestTop = monitorTop + s26.interest;
                const cutTop = interestTop + 3.5;
                const ax = x("Expenditure") + x.bandwidth();

                // Monitor Box
                if (s26.monitor > 0) {
                    g26.append("rect").attr("x", x("Expenditure")).attr("y", y(monitorTop)).attr("width", x.bandwidth()).attr("height", y(s26.expBase) - y(monitorTop)).attr("fill", "#e6c229").attr("stroke", "#333");
                    g26.append("line").attr("x1", ax).attr("y1", y(s26.expBase)).attr("x2", ax + 12).attr("y2", y(s26.expBase) - 10).attr("stroke", "#e6c229").attr("stroke-width", 2);
                    addText(g26, ax + 35, y(s26.expBase) - 15, "Monitor", "$150k", "#333", "10px");
                }

                // Interest Box
                if (s26.interest > 0) {
                    g26.append("rect").attr("x", x("Expenditure")).attr("y", y(interestTop)).attr("width", x.bandwidth()).attr("height", y(monitorTop) - y(interestTop)).attr("fill", "#f17105").attr("stroke", "#333");
                    const lineEndY = s26.monitor > 0 ? y(monitorTop) - 45 : y(monitorTop) - 20;
                    g26.append("line").attr("x1", ax).attr("y1", y(monitorTop)).attr("x2", ax + 12).attr("y2", lineEndY + 5).attr("stroke", "#f17105").attr("stroke-width", 2);
                    addText(g26, ax + 35, lineEndY, "Interest", s26.intText, "#333", "10px");
                }

                // Mid-year cuts
                g26.append("rect").attr("x", x("Expenditure")).attr("y", y(cutTop)).attr("width", x.bandwidth()).attr("height", y(interestTop) - y(cutTop)).attr("fill", "#e2efda").attr("stroke", "#333").attr("stroke-dasharray", "4");
                addText(g26, x("Expenditure") + x.bandwidth()/2, y(cutTop) + 14, "Mid Year Cuts", "Annualized $3.5M", "#333", "9px");

                // Gap Arrow
                drawArrow(g26, x("Revenue") + x.bandwidth(), y(s26.revSolid), y(interestTop), s26.gapText, "Cuts", "Needed");
            }
        }

        window.onload = init;
    </script>
</body>
</html>
